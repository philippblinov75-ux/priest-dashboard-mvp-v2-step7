---
---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Priest Dashboard — Регистрация прихода</title>
  <link rel="stylesheet" href="style.css?v={{ site.time | date: '%s' }}" />
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Priest Dashboard — Регистрация прихода</h1>
      <a href="admin.html"><button class="ghost">Панель модератора</button></a>
    </div>

    <div class="card grid">
      <div class="row">
        <div>
          <label>Имя батюшки</label>
          <input id="priestName" placeholder="напр. отец Елпидифор" />
        </div>
        <div>
          <label>Название прихода</label>
          <input id="parishName" placeholder="напр. Храм св. великомученика Георгия в Песках" />
          <div class="hint"><small>Ссылка сгенерируется автоматически по названию.</small></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Населённый пункт</label>
          <input id="city" placeholder="деревня/город, регион" />
        </div>
        <div>
          <label>Публичная ссылка (генерируется)</label>
          <input id="slugPreview" readonly />
        </div>
      </div>

      <div>
        <label>Описание храма</label>
        <textarea id="description" placeholder="Коротко о храме, святынях, расписании и т.д."></textarea>
      </div>

      <div class="row">
        <div>
          <label>Аватар батюшки (jpg/png)</label>
          <input id="avatar" type="file" accept="image/*" />
          <div id="avatarPreview" class="preview" style="display:none"></div>
        </div>
        <div>
          <label>Фото храма (jpg/png)</label>
          <input id="churchPhoto" type="file" accept="image/*" />
          <div id="churchPreview" class="preview" style="display:none"></div>
        </div>
      </div>

      <div class="flex">
        <button id="submitBtn">Отправить на модерацию</button>
        <button id="resetBtn" class="ghost">Сбросить форму</button>
        <div id="status"></div>
      </div>

      <small>Подсказка: публичная страница после аппрува откроется по адресу
        <kbd>parish.html?slug=&lt;slug&gt;</kbd>.
      </small>
    </div>
  </div>

  <!-- ВЕСЬ JS ИНЛАЙН -->
  <script>
  (function(){
    const KEY='pd.applications';
    const $ = s => document.querySelector(s);
    function load(){ try { return JSON.parse(localStorage.getItem(KEY)||'[]'); } catch(e){ return []; } }
    function save(a){ localStorage.setItem(KEY, JSON.stringify(a)); }
    function setStatus(msg='',kind=''){ $('#status').innerHTML = msg ? \`<span class="badge \${kind}">\${msg}</span>\` : ''; }

    // base URL (без index.html и query)
    function baseUrl(){
      let href = location.href;
      href = href.split('?')[0];
      if (href.endsWith('index.html')) href = href.slice(0, -'index.html'.length);
      if (!href.endsWith('/')) href += '/';
      return href;
    }

    // translit + уникальный slug
    function translit(str){
      const map={'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'e','ж':'zh','з':'z','и':'i','й':'y','к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'h','ц':'c','ч':'ch','ш':'sh','щ':'sch','ъ':'','ы':'y','ь':'','э':'e','ю':'yu','я':'ya'};
      return (str||'').toLowerCase().replace(/[ъь]+/g,'').replace(/[а-яё]/g,c=>map[c]||c).replace(/[^a-z0-9]+/g,'-').replace(/-+/g,'-').replace(/(^-|-$)/g,'');
    }
    function uniqueSlug(base){
      const apps = load();
      let slug = translit(base) || 'prihod', uniq = slug, i=2;
      while (apps.some(a => a.slug===uniq && a.status!=='declined')) uniq = \`\${slug}-\${i++}\`;
      return uniq;
    }
    function updateSlug(){
      try{
        const name = $('#parishName').value.trim();
        const slug = uniqueSlug(name);
        $('#slugPreview').value = baseUrl() + 'parish.html?slug=' + slug;
        $('#slugPreview').dataset.slug = slug;
      }catch(e){ console.error('updateSlug error', e); }
    }

    // JPEG компрессор
    function fileToCompressedDataURL(file,{maxSide=900,quality=0.82}={}){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onload=()=>{ const img=new Image();
          img.onload=()=>{ const c=document.createElement('canvas');
            let {width,height}=img; const s=Math.min(1,maxSide/Math.max(width,height));
            width=Math.round(width*s); height=Math.round(height*s);
            c.width=width; c.height=height; const ctx=c.getContext('2d');
            ctx.drawImage(img,0,0,width,height);
            resolve({ dataUrl:c.toDataURL('image/jpeg',quality), width, height });
          };
          img.onerror=reject; img.src=fr.result;
        };
        fr.onerror=reject; fr.readAsDataURL(file);
      });
    }
    async function buildPreview(inputEl, boxSel){
      const f = inputEl.files?.[0], box=$(boxSel);
      if(!f){ box.style.display='none'; box.innerHTML=''; delete box.dataset.dataurl; return; }
      setStatus('Обрабатываю фото…','pending');
      try{
        const {dataUrl,width,height}=await fileToCompressedDataURL(f,{maxSide:900,quality:0.82});
        const kb=Math.round((dataUrl.length*3/4)/1024);
        box.style.display='flex';
        box.innerHTML=\`<img src="\${dataUrl}"/><div><b>Файл:</b> \${f.name}<br/><small>Сжато до \${width}×\${height}, ~\${kb} KB</small></div>\`;
        box.dataset.dataurl=dataUrl;
      }catch(e){ console.error(e); setStatus('Не удалось обработать изображение.','declined'); }
      finally{ setStatus(''); }
    }

    const REQUIRED=[
      {sel:'#priestName',label:'Имя батюшки'},
      {sel:'#parishName',label:'Название прихода'},
      {sel:'#city',label:'Населённый пункт'},
      {sel:'#description',label:'Описание храма'}
    ];
    function validate(){
      const empty = REQUIRED.filter(f => !$(f.sel).value.trim());
      return empty.length ? {ok:false,msg:'Заполните: '+empty.map(f=>f.label).join(', ')} : {ok:true};
    }

    async function submit(){
      try{
        const v=validate(); if(!v.ok){ setStatus(v.msg,'declined'); return; }
        const apps=load();
        const slug=$('#slugPreview').dataset.slug || uniqueSlug($('#parishName').value.trim());
        if(apps.some(a=>a.slug===slug && a.status!=='declined')){ setStatus('Адрес уже занят. Измените название прихода.','declined'); return; }

        const item={
          id: crypto.randomUUID(),
          priestName: $('#priestName').value.trim(),
          parishName: $('#parishName').value.trim(),
          city: $('#city').value.trim(),
          slug,
          description: $('#description').value.trim(),
          avatarDataUrl: $('#avatarPreview').dataset.dataurl || '',
          churchDataUrl: $('#churchPreview').dataset.dataurl || '',
          status:'pending', declineReason:'', createdAt:new Date().toISOString()
        };

        apps.push(item); save(apps);
        setStatus('Заявка отправлена на модерацию','pending');
        setTimeout(()=> location.href='admin.html', 700);
      }catch(e){ console.error(e); setStatus('Фото слишком большие или хранилище переполнено.','declined'); }
    }

    function resetForm(){
      REQUIRED.forEach(f=>$(f.sel).value='');
      ['#avatarPreview','#churchPreview'].forEach(id=>{ const b=$(id); b.style.display='none'; b.innerHTML=''; delete b.dataset.dataurl; });
      updateSlug(); setStatus('');
    }

    document.addEventListener('DOMContentLoaded',()=>{
      console.log('inline index.js loaded');
      $('#parishName').addEventListener('input', updateSlug);
      updateSlug();

      REQUIRED.forEach(f => $(f.sel).addEventListener('input', ()=> setStatus('')));
      $('#avatar').addEventListener('change', e=>buildPreview(e.target,'#avatarPreview'));
      $('#churchPhoto').addEventListener('change', e=>buildPreview(e.target,'#churchPreview'));
      $('#submitBtn').addEventListener('click', submit);
      $('#resetBtn').addEventListener('click', resetForm);
    });
  })();
  </script>
</body>
</html>
